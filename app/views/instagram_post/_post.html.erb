<% likes_count = post.likes_count.to_i %>
<% comments_count = post.comments_count.to_i %>
<% video_view_count = post.video_view_count.to_i %>
<% total_interactions = likes_count + comments_count %>
<% engagement_rate = post.profile.followers > 0 ? ((total_interactions.to_f / post.profile.followers) * 100).round(2) : 0 %>
<% posted_on_text = post.posted_at.present? ? l(post.posted_at, format: :long) : nil %>
<% posted_on_iso = post.posted_at&.iso8601 %>
<% permalink = post.url.presence || (post.shortcode.present? ? "https://www.instagram.com/p/#{post.shortcode}" : nil) %>
<% compact_units = { thousand: 'K', million: 'M', billion: 'B' } %>

<!-- Media Type Colors -->
<% media_colors = {
  'VIDEO' => { badge: 'from-purple-500 to-pink-600', icon: 'bg-purple-50 text-purple-600' },
  'CAROUSEL_ALBUM' => { badge: 'from-blue-500 to-indigo-600', icon: 'bg-blue-50 text-blue-600' },
  'IMAGE' => { badge: 'from-green-500 to-emerald-600', icon: 'bg-green-50 text-green-600' }
} %>
<% current_media_colors = media_colors[post.media] || media_colors['IMAGE'] %>

<%if post.image.attached?%>
  <div class="group relative break-inside-avoid mb-8">
    <!-- Card Container -->
    <div class="relative overflow-hidden rounded-2xl bg-white shadow-md ring-1 ring-gray-900/5 transition-all duration-500 hover:shadow-2xl hover:-translate-y-2">
      
      <!-- Media Type Badge - Top Left -->
      <div class="absolute top-4 left-4 z-20">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gradient-to-r <%= current_media_colors[:badge] %> shadow-lg">
          <% if post.media == 'VIDEO' %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-white">
              <path d="M3.25 4A2.25 2.25 0 0 0 1 6.25v7.5A2.25 2.25 0 0 0 3.25 16h7.5A2.25 2.25 0 0 0 13 13.75v-7.5A2.25 2.25 0 0 0 10.75 4h-7.5ZM19 4.75a.75.75 0 0 0-1.28-.53l-3 3a.75.75 0 0 0-.22.53v4.5c0 .199.079.39.22.53l3 3a.75.75 0 0 0 1.28-.53V4.75Z" />
            </svg>
          <% elsif post.media == 'CAROUSEL_ALBUM' %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-white">
              <path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 0 1 3.25 3h13.5A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17H3.25A2.25 2.25 0 0 1 1 14.75v-9.5Zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-2.69l-2.22-2.219a.75.75 0 0 0-1.06 0l-1.91 1.909.47.47a.75.75 0 1 1-1.06 1.06L6.53 8.091a.75.75 0 0 0-1.06 0l-2.97 2.97ZM12 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z" clip-rule="evenodd" />
            </svg>
          <% else %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-white">
              <path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 0 1 3.25 3h13.5A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17H3.25A2.25 2.25 0 0 1 1 14.75v-9.5Zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-2.69l-2.22-2.219a.75.75 0 0 0-1.06 0l-1.91 1.909.47.47a.75.75 0 1 1-1.06 1.06L6.53 8.091a.75.75 0 0 0-1.06 0l-2.97 2.97ZM12 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z" clip-rule="evenodd" />
            </svg>
          <% end %>
          <span class="text-xs font-bold text-white uppercase tracking-wider"><%= post.media == 'CAROUSEL_ALBUM' ? 'Carrusel' : post.media.capitalize %></span>
        </div>
      </div>
      
      <!-- Product Type Badge - Top Right -->
      <div class="absolute top-4 right-4 z-20">
        <div class="inline-flex items-center px-3 py-1.5 rounded-full bg-white/95 backdrop-blur-md shadow-lg border border-white/20">
          <span class="text-xs font-semibold text-gray-700"><%= post.product_type.capitalize %></span>
        </div>
      </div>
      
      <!-- Image Container - Dynamic Height -->
      <div class="relative w-full overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200">
        <%= link_to permalink, target: "_blank", rel: "noopener", class: 'block w-full' do %>
                <%= image_tag(direct_blob_url(post.image), 
                  class: 'w-full h-auto object-cover transition-all duration-700 group-hover:scale-110 group-hover:brightness-110',
                  loading: 'lazy',
                  decoding: 'async',
                  alt: "Post de #{post.profile.username} - #{post.caption&.truncate(100) || 'Instagram'}"
                ) %>
          
          <!-- Gradient Overlay -->
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          
          <!-- Hover Stats Overlay - Premium Info -->
          <div class="absolute inset-x-0 bottom-0 z-10 p-6 transform translate-y-full group-hover:translate-y-0 transition-transform duration-500">
            <div class="space-y-3">
              <!-- Engagement Stats -->
              <div class="flex items-center gap-3 flex-wrap">
                <!-- Likes -->
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-pink-500 to-red-500 shadow-xl">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-white">
                    <path d="m9.653 16.915-.005-.003-.019-.01a20.759 20.759 0 0 1-1.162-.682 22.045 22.045 0 0 1-2.582-1.9C4.045 12.733 2 10.352 2 7.5a4.5 4.5 0 0 1 8-2.828A4.5 4.5 0 0 1 18 7.5c0 2.852-2.044 5.233-3.885 6.82a22.049 22.049 0 0 1-3.744 2.582l-.019.01-.005.003h-.002a.739.739 0 0 1-.69.001l-.002-.001Z" />
                  </svg>
                  <span class="text-sm font-bold text-white">
                    <%= number_to_human(likes_count, format: '%n%u', units: compact_units, precision: 1) %>
                  </span>
                </div>
                
                <!-- Comments -->
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/95 backdrop-blur-md shadow-xl border border-white/20">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-blue-600">
                    <path fill-rule="evenodd" d="M10 3c-4.31 0-8 3.033-8 7 0 2.024.978 3.825 2.499 5.085a3.478 3.478 0 0 1-.522 1.756.75.75 0 0 0 .584 1.143 5.976 5.976 0 0 0 3.936-1.108c.487.082.99.124 1.503.124 4.31 0 8-3.033 8-7s-3.69-7-8-7Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm-2-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm5 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                  </svg>
                  <span class="text-sm font-bold text-gray-900">
                    <%= number_to_human(comments_count, format: '%n%u', units: compact_units, precision: 1) %>
                  </span>
                </div>
                
                <!-- Video Views if present -->
                <% if video_view_count.positive? %>
                  <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-purple-500 to-indigo-600 shadow-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-white">
                      <path d="M6.3 2.84A1.5 1.5 0 0 0 4 4.11v11.78a1.5 1.5 0 0 0 2.3 1.27l9.344-5.891a1.5 1.5 0 0 0 0-2.538L6.3 2.841Z" />
                    </svg>
                    <span class="text-sm font-bold text-white">
                      <%= number_to_human(video_view_count, format: '%n%u', units: compact_units, precision: 1) %>
                    </span>
                    <span class="text-xs font-medium text-purple-100">views</span>
                  </div>
                <% end %>
              </div>
              
              <!-- CTA Button -->
              <div class="flex items-center justify-between pt-2">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-orange-500 via-pink-500 to-purple-600 shadow-xl">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-white">
                    <path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z" />
                    <path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z" />
                  </svg>
                  <span class="text-xs font-bold text-white uppercase tracking-wider">Ver en Instagram</span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-white">
                    <path fill-rule="evenodd" d="M3 10a.75.75 0 0 1 .75-.75h10.638L10.23 5.29a.75.75 0 1 1 1.04-1.08l5.5 5.25a.75.75 0 0 1 0 1.08l-5.5 5.25a.75.75 0 1 1-1.04-1.08l4.158-3.96H3.75A.75.75 0 0 1 3 10Z" clip-rule="evenodd" />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      
      <!-- Content Section - Enhanced -->
      <div class="relative p-6 bg-gradient-to-b from-white to-gray-50">
        <div class="space-y-3">
          <!-- Date -->
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-gray-400">
              <path fill-rule="evenodd" d="M5.75 2a.75.75 0 0 1 .75.75V4h7V2.75a.75.75 0 0 1 1.5 0V4h.25A2.75 2.75 0 0 1 18 6.75v8.5A2.75 2.75 0 0 1 15.25 18H4.75A2.75 2.75 0 0 1 2 15.25v-8.5A2.75 2.75 0 0 1 4.75 4H5V2.75A.75.75 0 0 1 5.75 2Zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75Z" clip-rule="evenodd" />
            </svg>
            <time datetime="<%= posted_on_iso %>" class="text-sm font-medium text-gray-600">
              <%= post.posted_at.strftime("%d/%m/%Y") %>
            </time>
          </div>
          
          <!-- Quick Stats Bar -->
          <div class="flex items-center gap-4 pt-3 border-t border-gray-200">
            <!-- Likes -->
            <div class="flex items-center gap-1.5">
              <div class="flex items-center justify-center w-8 h-8 rounded-lg <%= current_media_colors[:icon] %>">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path d="m9.653 16.915-.005-.003-.019-.01a20.759 20.759 0 0 1-1.162-.682 22.045 22.045 0 0 1-2.582-1.9C4.045 12.733 2 10.352 2 7.5a4.5 4.5 0 0 1 8-2.828A4.5 4.5 0 0 1 18 7.5c0 2.852-2.044 5.233-3.885 6.82a22.049 22.049 0 0 1-3.744 2.582l-.019.01-.005.003h-.002a.739.739 0 0 1-.69.001l-.002-.001Z" />
                </svg>
              </div>
              <div class="flex flex-col">
                <span class="text-xs font-bold text-gray-900 leading-none">
                  <%= number_to_human(likes_count, format: '%n%u', units: compact_units, precision: 1) %>
                </span>
                <span class="text-[10px] text-gray-500 leading-none mt-0.5">likes</span>
              </div>
            </div>
            
            <!-- Comments -->
            <div class="flex items-center gap-1.5">
              <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-50 text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path fill-rule="evenodd" d="M10 3c-4.31 0-8 3.033-8 7 0 2.024.978 3.825 2.499 5.085a3.478 3.478 0 0 1-.522 1.756.75.75 0 0 0 .584 1.143 5.976 5.976 0 0 0 3.936-1.108c.487.082.99.124 1.503.124 4.31 0 8-3.033 8-7s-3.69-7-8-7Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm-2-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm5 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="flex flex-col">
                <span class="text-xs font-bold text-gray-900 leading-none">
                  <%= number_to_human(comments_count, format: '%n%u', units: compact_units, precision: 1) %>
                </span>
                <span class="text-[10px] text-gray-500 leading-none mt-0.5">comments</span>
              </div>
            </div>
            
            <!-- Engagement Rate -->
            <% if engagement_rate > 0 %>
              <div class="ml-auto flex items-center gap-1.5">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-green-50 text-green-600">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-11.25a.75.75 0 0 0-1.5 0v2.5h-2.5a.75.75 0 0 0 0 1.5h2.5v2.5a.75.75 0 0 0 1.5 0v-2.5h2.5a.75.75 0 0 0 0-1.5h-2.5v-2.5Z" clip-rule="evenodd" />
                  </svg>
                </div>
                <div class="flex flex-col">
                  <span class="text-xs font-bold text-gray-900 leading-none"><%= engagement_rate %>%</span>
                  <span class="text-[10px] text-gray-500 leading-none mt-0.5">engage</span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      
      <!-- Animated Border on Hover -->
      <div class="absolute inset-0 rounded-2xl ring-2 ring-<%= post.media == 'VIDEO' ? 'purple' : (post.media == 'CAROUSEL_ALBUM' ? 'blue' : 'green') %>-500 opacity-0 scale-95 group-hover:opacity-100 group-hover:scale-100 transition-all duration-500 pointer-events-none"></div>
      
      <!-- Corner Accent -->
      <div class="absolute -top-1 -right-1 w-20 h-20 bg-gradient-to-br <%= current_media_colors[:badge] %>/10 rounded-full blur-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
    </div>
  </div>
<%end%>
